{% extends "base.html" %}
{% load static %}

{% block title %}Mis finanzas{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row mb-4">
    <div class="col">
      <h1 class="display-4 fw-bold" style="color: var(--color-principal);">Mis Cuentas</h1>
    </div>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <!-- Tarjeta para agregar nueva cuenta -->
    <div class="col">
      <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#cuentaModal">
        <div class="card h-100 border-0 shadow-sm card-add-hover">
          <div class="card-body d-flex flex-column align-items-center justify-content-center" style="min-height: 200px;">
            <div class="add-icon mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
              </svg>
            </div>
            <h5 class="card-title text-center fw-bold">Nueva Cuenta</h5>
            <p class="card-text text-center text-muted small">Agregar una nueva cuenta</p>
          </div>
        </div>
      </a>
    </div>

    <!-- Tarjetas de cuentas existentes -->
    {% for cuenta in cuentas %}
    <div class="col">
      <div class="card h-100 border-0 shadow-sm card-cuenta-hover">
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h5 class="card-title fw-bold mb-0" style="color: var(--color-principal);">
              {{ cuenta.nombre }}
            </h5>
            <div class="dropdown">
              <button class="btn btn-link p-0 text-muted" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                  <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                </svg>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <button class="dropdown-item edit-cuenta-btn" type="button"
                          data-id="{{ cuenta.id }}"
                          data-nombre="{{ cuenta.nombre|escapejs }}"
                          data-descripcion="{{ cuenta.descripcion|default:''|escapejs }}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil me-2" viewBox="0 0 16 16">
                      <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                    </svg>
                    Editar
                  </button>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <button class="dropdown-item text-danger" onclick="confirmarEliminacion(event, {{ cuenta.id }})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash me-2" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                      <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                    Eliminar
                  </button>
                </li>
              </ul>
            </div>
          </div>
          
          <p class="card-text text-muted flex-grow-1">
            {{ cuenta.descripcion|default:"Sin descripción" }}
          </p>
          
          <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <small class="text-muted">Balance actual</small>
            </div>
            <h3 class="fw-bold mb-3" style="color: var(--color-secundario);">
              ${{ cuenta.balance|floatformat:2 }}
            </h3>
            
            <a href="{% url 'dashboards:detalle_cuenta' cuenta.id %}" class="btn btn-principal w-100">
              Ver detalles
            </a>
          </div>
        </div>
        
        <form id="form-eliminar-{{ cuenta.id }}" method="post"
              action="{% url 'dashboards:eliminar_cuenta' cuenta.id %}"
              style="display:none;">
          {% csrf_token %}
        </form>
      </div>
    </div>
    {% empty %}
    {% endfor %}
  </div>
  
  {% if not cuentas %}
  <div class="row mt-4">
    <div class="col text-center">
      <div class="alert alert-info" role="alert">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-info-circle me-2" viewBox="0 0 16 16">
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
          <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>
        No tienes cuentas registradas. ¡Crea tu primera cuenta para comenzar!
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
function confirmarEliminacion(event, cuentaId) {
  event.preventDefault();
  if (confirm("¿Seguro que deseas eliminar esta cuenta?")) {
    document.getElementById('form-eliminar-' + cuentaId).submit();
  }
}
</script>

<!-- Modal para crear/editar cuenta -->
<div class="modal fade" id="cuentaModal" tabindex="-1" aria-labelledby="cuentaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cuentaModalLabel">Nueva Cuenta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form method="post" action="{{ form_action }}">
        {% csrf_token %}
        <div class="modal-body">
          {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="container-fluid">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="id_nombre" class="form-label">Nombre</label>
                {{ form.nombre }}
                {% if form.nombre.errors %}
                  <div class="invalid-feedback d-block">{{ form.nombre.errors|striptags }}</div>
                {% endif %}
              </div>

              <div class="col-12 col-md-6">
                <label for="id_descripcion" class="form-label">Descripción</label>
                {{ form.descripcion }}
                {% if form.descripcion.errors %}
                  <div class="invalid-feedback d-block">{{ form.descripcion.errors|striptags }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-principal">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if open_modal %}
<script>
  // Abrir modal si la vista indicó que hay errores en el formulario
  document.addEventListener('DOMContentLoaded', function() {
    var myModal = new bootstrap.Modal(document.getElementById('cuentaModal'));
    myModal.show();
  });
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Template URL for editing (contains 0 to replace)
  var editUrlTemplate = "{% url 'dashboards:editar_cuenta' 0 %}";

  // Handle clicks on edit buttons: populate modal and change form action
  document.querySelectorAll('.edit-cuenta-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      var id = btn.getAttribute('data-id');
      var nombre = btn.getAttribute('data-nombre') || '';
      var descripcion = btn.getAttribute('data-descripcion') || '';

      var modalEl = document.getElementById('cuentaModal');
      var modal = new bootstrap.Modal(modalEl);

      // Set title and button
      var title = modalEl.querySelector('.modal-title');
      if (title) title.textContent = 'Editar Cuenta';
      var submitBtn = modalEl.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.textContent = 'Guardar cambios';

      // Set form action to edit URL
      var form = modalEl.querySelector('form');
      if (form) {
        var editUrl = editUrlTemplate.replace('/0/', '/' + id + '/');
        form.action = editUrl;
      }

      // Fill fields if present
      var nombreInput = modalEl.querySelector('[name="nombre"]');
      if (nombreInput) nombreInput.value = nombre;
      var descInput = modalEl.querySelector('[name="descripcion"]');
      if (descInput) descInput.value = descripcion;

      modal.show();
    });
  });
});
</script>

{% endblock %}