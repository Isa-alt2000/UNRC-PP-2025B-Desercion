{% extends "base.html" %}
{% load static %}

{% block title %}Detalle de la cuenta{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Encabezado de la cuenta -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start flex-wrap">
        <div class="mb-3 mb-md-0">
          <h2 class="card-title mb-2">{{ cuenta.nombre }}</h2>
          <p class="card-text text-muted mb-2">{{ cuenta.descripcion }}</p>
          <h4 class="mb-0">
            <span class="badge bg-secundario">Balance: ${{ balance }}</span>
          </h4>
        </div>
        <div>
          <a href="{% url 'dashboards:prediccion' cuenta.id %}" class="btn btn-secundario btn-lg me-2">
            <i class="bi bi-graph-up me-2"></i>Predecir mis ahorros
          </a>
          <button type="button" class="btn btn-principal btn-lg" onclick="abrirModal()">
            <i class="bi bi-plus-circle me-2"></i>Agregar movimiento
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="movimientoModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Agregar Movimiento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="post" id="movimientoForm">
            {% csrf_token %}
            <div class="container-fluid">
              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label for="id_tipo" class="form-label">Tipo</label>
                  {{ form.tipo }}
                  {% if form.tipo.errors %}
                    <div class="invalid-feedback d-block">{{ form.tipo.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="col-12 col-md-4">
                  <label for="id_monto" class="form-label">Monto</label>
                  {{ form.monto }}
                  {% if form.monto.errors %}
                    <div class="invalid-feedback d-block">{{ form.monto.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="col-12 col-md-4">
                  <label for="id_fecha" class="form-label">Fecha</label>
                  {{ form.fecha }}
                  {% if form.fecha.errors %}
                    <div class="invalid-feedback d-block">{{ form.fecha.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="col-12">
                  <label for="id_concepto" class="form-label">Concepto</label>
                  {{ form.concepto }}
                  {% if form.concepto.errors %}
                    <div class="invalid-feedback d-block">{{ form.concepto.errors|striptags }}</div>
                  {% endif %}
                </div>

                <div class="col-12">
                  <label for="id_descripcion" class="form-label">Descripción</label>
                  {{ form.descripcion }}
                  {% if form.descripcion.errors %}
                    <div class="invalid-feedback d-block">{{ form.descripcion.errors|striptags }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="movimientoForm" class="btn btn-principal">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h5 class="mb-0">Movimientos</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Fecha</th>
              <th>Concepto</th>
              <th>Tipo</th>
              <th class="text-end">Monto</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for mov in movimientos %}
              <tr class="{% if mov.tipo == 'INGRESO' %}table-ingreso{% else %}table-egreso{% endif %}">
                <td>{{ mov.fecha|date:"j M. Y" }}</td>
                <td>{{ mov.concepto }}</td>
                <td>
                  {% if mov.tipo == 'INGRESO' %}
                    <span class="badge bg-success-custom">Ingreso</span>
                  {% else %}
                    <span class="badge bg-danger-custom">Egreso</span>
                  {% endif %}
                </td>
                <td class="text-end fw-bold">
                  {% if mov.tipo == 'INGRESO' %}
                    <span class="text-success-custom">+${{ mov.monto }}</span>
                  {% else %}
                    <span class="text-danger-custom">-${{ mov.monto }}</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="btn-group" role="group">
                    <button
                      class="btn btn-square btn-outline-secundario"
                      type="button"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="{{ mov.descripcion|default:'Sin descripción'|striptags }}"
                      aria-label="Descripción">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M12,2A10,10,0,1,0,22,12,10,10,0,0,0,12,2Zm1,15a1,1,0,0,1-2,0V11a1,1,0,0,1,2,0ZM12,8a1.5,1.5,0,1,1,1.5-1.5A1.5,1.5,0,0,1,12,8Z"/>
                      </svg>
                    </button>
                    <button
                      onclick="editarMovimiento(this)"
                      data-id="{{ mov.id }}"
                      data-concepto="{{ mov.concepto|escapejs }}"
                      data-tipo="{{ mov.tipo }}"
                      data-monto="{{ mov.monto }}"
                      data-fecha="{{ mov.fecha|date:'Y-m-d' }}"
                      data-descripcion="{{ mov.descripcion|default:''|escapejs }}"
                      class="btn btn-square btn-outline-primary"
                      title="Editar" aria-label="Editar">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path d="M20.548 3.452a1.542 1.542 0 0 1 0 2.182l-7.636 7.636-3.273 1.091 1.091-3.273 7.636-7.636a1.542 1.542 0 0 1 2.182 0zM4 21h15a1 1 0 0 0 1-1v-8a1 1 0 0 0-2 0v7H5V6h7a1 1 0 0 0 0-2H4a1 1 0 0 0-1 1v15a1 1 0 0 0 1 1z"/>
                      </svg>
                    </button>
                    <form method="post"
                      action="{% url 'dashboards:eliminar_movimiento' cuenta.id mov.id %}"
                      style="display:inline;"
                      onsubmit="return confirmarEliminacion(event)">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-square btn-outline-primary" title="Eliminar" aria-label="Eliminar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                          <path d="M5.755 20.283 4 8h16l-1.755 12.283A2 2 0 0 1 16.265 22h-8.53a2 2 0 0 1-1.98-1.717zM21 4h-5V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v1H3a1 1 0 0 0 0 2h18a1 1 0 0 0 0-2z"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" class="text-center py-4 text-muted">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  No hay movimientos aún.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Botón volver -->
  <div class="mt-4 mb-5">
    <a href="{% url 'dashboards:lista_cuentas' %}" class="btn btn-secundario">
      <i class="bi bi-arrow-left me-2"></i>Volver
    </a>
  </div>
</div>

<script>
function confirmarEliminacion(event) {
    event.preventDefault();
    const confirmacion = confirm("¿Seguro que deseas eliminar este movimiento?");
    if (confirmacion) {
        event.target.submit();
    }
}

function abrirModal() {
    const modal = new bootstrap.Modal(document.getElementById('movimientoModal'));
    document.getElementById('modalTitle').textContent = 'Agregar Movimiento';
    document.getElementById('movimientoForm').setAttribute('action', '{% url "dashboards:agregar_movimiento" cuenta.id %}');
    modal.show();
}

function editarMovimiento(btn) {
  const modal = new bootstrap.Modal(document.getElementById('movimientoModal'));
  document.getElementById('modalTitle').textContent = 'Editar Movimiento';

  // Leer datos desde data-attributes del botón
  const id = btn.getAttribute('data-id');
  const concepto = btn.getAttribute('data-concepto') || '';
  const tipo = btn.getAttribute('data-tipo') || '';
  const monto = btn.getAttribute('data-monto') || '';
  const fecha = btn.getAttribute('data-fecha') || '';
  const descripcion = btn.getAttribute('data-descripcion') || '';

  // Actualizar el formulario con los datos existentes
  const conceptoEl = document.getElementById('id_concepto');
  if (conceptoEl) conceptoEl.value = concepto;
  const tipoEl = document.getElementById('id_tipo');
  if (tipoEl) tipoEl.value = tipo;
  const montoEl = document.getElementById('id_monto');
  if (montoEl) montoEl.value = monto;
  const fechaEl = document.getElementById('id_fecha');
  if (fechaEl) fechaEl.value = fecha;
  const descEl = document.getElementById('id_descripcion');
  if (descEl) descEl.value = descripcion;

  // Cambiar la URL del formulario para edición
  document.getElementById('movimientoForm').setAttribute('action',
    '{% url "dashboards:detalle_cuenta" cuenta.id %}' + 'editar-movimiento/' + id + '/');

  modal.show();
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.forEach(function (el) {
    try {
      new bootstrap.Tooltip(el);
    } catch (e) {
      // ignore if bootstrap not available
    }
  });
});
</script>
{% endblock %}